\chapter{Hardware}

\section{Die Schaltung des TransistorTesters}
\label{sec:hardware}
Die Schaltung des TransistorTesters in Abbildung~\ref{fig:ttester} basiert auf der Schaltung von
Markus F., die er in Abb. 1 des AVR-Transistortester Reports \cite{Frejek} ver\"offentlicht hat.
Ge\"anderte oder verschobene Bauteile sind mit gr\"uner Farbe markiert, optionale Teile sind
mit roter Farbe gekennzeichnet.
Einige \"Anderungen wurden gemacht, weil die Strom-Abschaltung in einigen Nachbauten Probleme
bereitet hatte.
Deshalb ist der Widerstand R7 auf \(3.3k\Omega\) reduziert. 
Der Kondensator C2 ist auf 10nF verkleinert und der Widerstand R8 ist verschoben, so da"s der
Ausgang PD6 nicht versucht den C2 Kondenstor direkt zu laden.
Zus\"atzliche Abblock-Kondensatoren wurden hinzugef\"ugt und sollten nahe den Versorgungs-Anschl\"ussen
des ATmega und nahe bei dem Spannungsregler plaziert werden.
Weil der PD7 Eingang und der PC6 (RESET) Anschlu"s die einzigen Anschl\"usse sind, wo
,,pull-up'' Widerst\"ande gebraucht werden, wurde ein zus\"atzlicher \(27k\Omega\) Widerstand an dem PD7 (Pin 13) Anschlu"s vorgesehen.
Mit dieser \"Anderung k\"onnen die internen ,,pull-up'' Widerst\"ande des ATmega abgeschaltet werden.
Ein Quarz mit seinen 22pF Kondensatoren wurde zus\"atzlich vorgesehen.
Ein Quarz hat Vorteile f\"ur die Kapazit\"atsmessung wegen der genaueren Zeitmessung.
Die neue Software kann den Bereich f\"ur den ADC umschalten. Die Umschalt-Geschwindigkeit
wird durch den externen Kondensator C1 am AREF (21) Pin des ATmega reduziert.
Um die Messung nicht langsamer als notwendig machen zu m\"ussen, sollte der Kondensator auf
1nF reduziert werden. Ein Entfernen des Kondensators ist ebenfalls m\"oglich.
Zum Anpassen der Software an die jeweilige Schaltung schauen Sie bitte in dem
Konfigurations-Kapitel~\ref{sec:config} nach. 
Einige unterschiedliche Versionen von R11 / R12 Kombinationen zirkulieren im Internet.
Ich habe die Software an den Original-Entwurf von Markus F.~\cite{Frejek} mit \(10k\Omega\) und \(3,3k\Omega\) angepa"st.
Die zus\"atzliche 2,5V Pr\"azisions-Spannungsreferenz, die an Pin PC4 (ADC4) angeschlossen ist,
wird f\"ur die \"Uberpr\"ufung und Kalibration der VCC Versorgungsspannung benutzt, ist aber nicht
erforderlich.
Ein zus\"atzlicher ISP-Anschlu"s wurde hinzugef\"ugt um leichter neue Software-Versionen
laden zu k\"onnen.

\begin{figure}[H]
\centering
\includegraphics[width=18cm]{../FIG/ttester.eps}
\caption{Neue TransistorTester-Schaltung}
\label{fig:ttester}
\end{figure}

Um einen einfacheren Anschlu"s des Displays an den ATmega auf Streifenleiter Platinen zu erreichen,
kann die Software auch eine andere Port D Belegung ber\"ucksichtigen.
Die folgende Tabelle \ref{tab:grid-change} zeigt die \"Anderungen der Pin Belegungen.

\begin{table}[H]
  \begin{center}
    \begin{tabular}{| c | c | c |}
    \hline
       Signal & Schaltbild & Streifenleiter\\
    \hline
    Tastensignal  &  PD7   &  PD0 \\
    LCD-RS    &  PD4      & PD7 \\
    LCD-E     &  PD5   & PD5 \\
    LCD-D4    &  PD0   & PD4 \\
    LCD-D5    &  PD1   & PD3 \\
    LCD-D6    &  PD2   & PD2 \\
    LCD-D7    &  PD3   & PD1 \\
    \hline
    \end{tabular}
  \end{center}
  \caption{\"Anderungen f\"ur Streifenleiter-Platine}
  \label{tab:grid-change}
\end{table}


\section{Hinweise f\"ur den Aufbau des TransistorTesters}
Jede LCD-Anzeige-Einheit mit mindestens 2x16 Zeichen und einem HD44780 kompatiblen Kontroller kann mit
dem TransistorTester benutzt werden.
Man sollte auf den Strombedarf der Hintergrundbeleuchtung achten, einige Anzeigen ben\"otigen
mehr Strom als andere.
Ich habe OLED Anzeigen ausprobiert, aber diese Anzeigen haben die Messung des
ATmega beeinflu"st und werden nicht empfohlen.
Die Widerst\"ande R1 bis R6 sind kritisch f\"ur die Messungen und diese \(680\Omega\) und
\(470k\Omega\) Widerst\"ande sollten Me"swiderst\"ande sein (Toleranz von 0,1\%), um 
die volle Genauigkeit zu erreichen.
Man sollte Pr\"azisions-Sockel f\"ur den ATmega Mikrocontroller verwenden um
die Austauschbarkeit des Mikrocontrollers sicherzustellen.
Es kann ein ATmega8, ATmega88, ATmega168 und ATmega328 Mikrocontroller verwendet werden.
Empfohlen werden ATmega168 oder ATmega328, wenn man alle Funktionen nutzen m\"ochte.
Jedenfalls sollte man zuerst alle Bauteile ohne den Mikrocontroller best\"ucken.
Es wird als IC2 ein moderner ,,low voltage drop'' Spannungsregler wie MCP1702-5002 empfohlen, weil
der nur \(2\mu A\) Ruhestrom ben\"otigt und auch noch 5V liefern kann, 
 wenn die Eingangsspannung nur 5,4V betr\"agt.
Aber dieser Regler ist leider nicht Pin-kompatibel zum bekannteren 78L05 Regler im TO-92 Geh\"ause!

Nachdem alle ben\"otigten Bauteile best\"uckt sind, sollte zuerst die Batterie
oder das Netzteil angeschlossen werden ohne angeschlossene LCD-Anzeige
und ohne eingesteckten Mikrocontroller.
Man sollte die Betriebsspannung des Mikrocontrollers und der LCD-Anzeige
\"uberpr\"ufen w\"ahrend der Start-Taster gedr\"uckt wird.
Die Betriebsspannung sollte verschwinden, wenn man den Start-Taster losl\"a"st.
Wenn die Betriebsspannung die richtige Polarit\"at und Gr\"o"se hatte,
sollte man die Strom-Versorgung entfernen und den Mikrocontroller 
richtig herum einstecken. Sind Sie bitte vorsichtig und stellen Sie sicher,
da"s alle Pinne des Mikrocontrollers im Sockel stecken.
Danach k\"onnen Sie das LCD anschlie"sen. Pr\"ufen Sie, da"s die GND und VCC
Anschl\"usse des LCD richtig mit der Baugruppe verbunden sind.

Wenn Sie sicher sind, da"s alles richtig angeschlossen ist, schlie"sen Sie
die Spannungsversorgung wieder an.
Wenn Sie den ATmega schon programmiert haben, k\"onnen Sie den Start-Taster
dr\"ucken.
Durch das Dr\"ucken des Start-Tasters sollte die Hintergrundbeleuchtung
der LCD-Anzeige angehen.
Wenn Sie den Taster loslassen, sollte die LED auf der Platine schwach leuchten.
Beachte, da"s die Software f\"ur den Mikrocontroller f\"ur den richtigen
Prozessor-Typ \"ubersetzt sein mu"s. Ein Programm f\"ur den ATmega8 l\"auft
nicht auf einem ATmega168!

\section{Programmierung des Mikrocontrollers}
Ich gebe die Software f\"ur den Mikrocontroller in Quell-Text heraus.
Die Entwicklung wurde mit dem Linux Betriebssystem (Ubuntu) gemacht
und wird gesteuert mit einer Makefile.
Die Makefile stellt sicher, da"s die Software entsprechend der vorher in der Makefile 
eingestellten Optionen \"ubersetzt wird. Schauen Sie bitte in die LiesMich.txt Datei
im Verzeichnis Sourcecode/default und in das Konfigurations-Kapitel~\ref{sec:config}.
Das Ergebnis der \"Ubersetzung hat die Dateierweiterung .hex und .eep.
\"Ublicherweise hei"sen die Dateien TransistorTester.hex und TransistorTester.eep .
Die .hex Datei enth\"alt die Daten f\"ur den Programm Speicher (flash) des ATmega Prozessors.
Die .eep Datei enth\"alt die Daten f\"ur den EEprom Speicher des ATmega.
Beide Dateien m\"ussen in den richtigen Speicher geladen werden.

Zus\"atzlich mu"s der ATmega mit den ,,fuses'' richtig konfiguriert werden.
Wenn Sie meine Makefile zusammen mit dem Programm avrdude benutzen, brauchen Sie
keine genaue Kenntnis \"uber die Einzelheiten der fuses.
Sie brauchen nur ,,make fuses'' aufrufen, wenn Sie keinen Quarz benutzen oder Sie
m\"ussen ,,make fuses-crystal'' aufrufen, wenn Sie einen 8MHz Quarz auf der Baugruppe installiert haben.
Bei der ATmega168 Serie der Mikrocontroller k\"onnen Sie alternativ auch
,,make fuses-crystal-lp'' aufrufen f\"ur den low power Quarz Betrieb.
Benutzen Sie niemals die Quarz-Variante, wenn Sie keinen 8MHz Quarz installiert haben.
Wenn Sie sich nicht sicher mit den fuses sind, lassen Sie diese erst einmal wie
vom Werk gesetzt und bringen Sie den Tester in diesem Zustand zum Laufen.
Es kann sein, da"s das Programm zu langsam l\"auft, wenn Sie die f\"ur den 8MHz Betrieb 
erzeugten Programmdaten benutzen, aber das kann man sp\"ater korrigieren!
Aber falsch gesetzte fuses k\"onnen die sp\"atere ISP-Programmierung verhindern.

\section{Fehlersuche}
Bei den meisten Problemen werden Sie den Text auf dem LCD-Display vermissen.
Zuerst sollten Sie pr\"ufen, ob die LED auf der Platine schwach leuchtet, wenn Sie den Start-Taster
loslassen.
\begin{description}

\item[Ger\"at schaltet nicht ein]  
Wenn die LED nicht leuchtet, aber die VCC Spannung den richtigen Wert hat, wenn
man den Start-Taster ged\"uckt h\"alt, schaltet der Mikrocontroller nicht richtig ein.
Der Mikrocontroller sollte die Spannung behalten indem der Ausgang PD6 auf 5V
geschaltet wird, was \"ublicherweise als eine der ersten Aktionen getan wird.
Wenn man die Start-Taste gedr\"uckt h\"alt, bleibt die Spannung ohnehin eingeschaltet.
So k\"onnen Sie mit gedr\"ucktem Taster den Wert der VCC-Spannung und zus\"atzlich den Spannungswert am
Ausgang PD6 pr\"ufen.
Wenn die VCC Spannung den richtigen Wert (5V) hat, aber die Spannung am Ausgang
PD6 unter 4V ist, startet der Mikrocontroller nicht richtig.
F\"ur diesen Fall sollten Sie pr\"ufen, ob die Programmdaten f\"ur den flash Speicher
f\"ur den richtigen Prozessor-Typ ist und ob der Prozessor richtig konfiguriert ist (fuses).
Wenn der ATmega den Ausgang PD6 auf 5V schaltet und die Betriebsspannung 
trotzdem nicht eingeschaltet bleibt, wenn man den Start-Taster losl\"a"st, ist der
Grund schwieriger zu finden.
Zuerst kann man die LED kurzschlie"sen und es noch einmal versuchen.
Wenn der Tester jetzt startet, ist die LED m\"oglicherweise falsch herum eingebaut.
Wenn das nicht die Ursache ist, k\"onnte der Grund ein unzureichender Stromverst\"arkungs-Faktor
des Transistors T3 (BC557C) sein.
Der Strom in die Basis von T3 ist niedriger, wenn der Mikrocontroller mit der LED einschaltet
wie im ,,Taster gedr\"uckt'' Zustand.

\item[Nichts ist lesbar auf der LCD-Anzeige] 
Pr\"ufen Sie die Spannung am Kontrast-Pin der LCD-Anzeige (Pin 3).
Stellen Sie mit dem Trimmer den Wert auf einen im Datenblatt angegebenen Wert und optimieren Sie
durch Sichtkontrolle.
Wenn Sie ein Hochtemperatur-Display haben, brauchen Sie eine negative Kontrast-Spannung f\"ur
den Betrieb.
In diesem Fall kann man den ICL~7660 Baustein zum Erzeugen der negativen Spannung aus der
positiven 5V verwenden.
Wenn keine Anzeige auf dem LCD erkannt wird und wenn die Hintergrundbeleuchtung an ist,
sollten Sie die Spannungsversorgung trennen und alle vier Datenverbindungen sowie die 
beiden Steuersignale \"uberpr\"ufen.
Wenn alle Verbindungen in Ordnung sind, sehe ich als Ursache nur noch die M\"oglichkeit einer
falschen Zeitabfolge der Steuersignale.
Die Ursache hierf\"ur kann sein, da"s der LCD-Kontroller langsamer ist als es die Software
des ATmega erwartet. Es k\"onnte auch sein, da"s der ATmega auf der falschen Taktrate l\"auft.
Bitte \"uberpr\"ufen Sie f\"ur welche Taktrate die Software \"ubersetzt ist und ob
die fuses des ATmega f\"ur diese Geschwindigkeit richtig gesetzt sind.
Sie finden die eingestellte Taktrate in der betreffenden Makefile.

\item[Einiges, aber nicht alles ist auf der LCD-Anzeige lesbar] 
\"Uberpr\"ufen Sie ob die .eep Daten in den EEprom Speicher des ATmega geladen wurden.
Wenn alle Programmdaten richtig geladen wurden, sollten Sie die Taktrate ihrer
Programmdaten (Makefile) und die ATmega Prozessor Einstellungen pr\"ufen (fuses).

\item[Messung ist zu langsam und Kapazit\"aten werden um Faktor 8 zu klein gemessen.] 
Sie betreiben die Software, die f\"ur 8MHz \"ubersetzt wurde mit einer Taktrate von 1MHz.
Bitte konfigurieren Sie den ATmega mit den fuses richtig.

\item[Die Messung ergibt seltsame Ergebnisse]  
\"Uberpr\"ufe ob der ISP Programmierstecker noch verbunden ist.
Der ISP-Stecker sollte nicht w\"ahrend einer Messung eingesteckt bleiben.
Sehr oft ist der Grund f\"ur falsche Me"sergebnisse, da"s die Software mit der
 AUTOSCALE\_ADC Option und der NO\_REF\_CAP Option \"ubersetzt wurde, aber der
Kondensator am AREF Pin hat immer noch einen Wert von 100nF.
Falsche Best\"uckung von Bauteilen k\"onnen auch eine Ursache f\"ur Me"sfehler sein 
oder zur\"uckgebliebene Flu"smittelreste k\"onnen die Messung st\"oren.
Bitte pr\"ufen Sie nach M\"oglichkeit mit der Selbsttest-Funktion der
TransistorTester Software.
Zu den Einzelheiten schauen Sie in das Selbsttest Kapitel \ref{sec:selftest}.
Anderenfalls pr\"ufen sie Ihre Platine visuell und pr\"ufen Sie die Widerstandswerte
mit einem Ohmmeter. Sie k\"onnen die Pinne des ATmega f\"ur diese Pr\"ufung benutzen,
zum Beispiel k\"onnen Sie der Widerstand R1 zwischen Pin 23 und Pin 14 messen.
Schauen Sie in das Schaltbild \ref{fig:ttester} f\"ur die Einzelheiten.
Man braucht den Mikrocontroller nicht zu entfernen, nur die Stromversorgung sollte
vorher getrennt werden.

\end{description}
